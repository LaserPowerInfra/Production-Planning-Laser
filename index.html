<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Production Planning Laser</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;padding:0;width:100%;height:100%;font-family:Segoe UI,Arial,sans-serif}
#bgVideo{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-2}
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:-1}
header{background:rgba(13,110,253,.98);color:#fff;padding:15px;text-align:center;font-size:22px;font-weight:600;position:sticky;top:0;z-index:1000}
.card{max-width:850px;margin:30px auto;background:#fff;padding:25px;border-radius:10px}
#loginSection{text-align:center;padding:50px 20px}
.btn-google{background:#fff;border:1px solid #ddd;padding:12px 25px;border-radius:50px;font-weight:600;cursor:pointer}
.user-info{background:#e7f1ff;color:#0d6efd;padding:10px;border-radius:6px;margin-bottom:20px;font-weight:bold}
#formSection{display:none}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.full-width{grid-column:1/-1}
label{font-size:13px;font-weight:600}
.req::after{content:" *";color:red}
input,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px}
input[readonly]{background:#f1f3f6}
.combo{position:relative}
.combo-list{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ccc;display:none;z-index:100;max-height:200px;overflow:auto}
.combo-list div{padding:10px;cursor:pointer}
.combo-list div:hover{background:#eee}
button.submit-btn{grid-column:1/-1;padding:12px;background:#0d6efd;color:#fff;border:none;border-radius:6px}
</style>
</head>

<body>

<header>Production Planning Laser</header>

<div class="card">

<div id="loginSection">
  <button onclick="googleLogin()" class="btn-google">Sign in with Google</button>
</div>

<div id="formSection">
<div class="user-info" id="userInfoDisplay"></div>

<form class="form-grid" id="entryForm">
<input type="hidden" id="userEmail" name="userEmail">

<div class="full-width">
<label class="req">MACHINE NAME</label>
<div class="combo">
<input id="machineInput" name="machine" autocomplete="off" required>
<div id="machineList" class="combo-list"></div>
</div>
</div>

<div><label class="req">Cost Code</label><input id="costCode" name="costCode" readonly></div>
<div><label class="req">ITEM NAME</label><input name="itemName" required></div>
<div><label class="req">Plan</label><input id="plan" name="plan" type="number"></div>
<div><label class="req">Mfg</label><input id="mfg" name="mfg" type="number"></div>
<div><label class="req">UM</label><select name="um"><option>KG</option><option>KM</option></select></div>
<div><label class="req">KM / Balance</label><input id="kmBalance" name="kmBalance" readonly></div>
<div><label class="req">MC No</label><input name="mcNo"></div>
<div><label class="req">Target / Day</label><input name="targetDay"></div>
<div><label class="req">RM Availability</label><select name="rmAvail"><option>Yes</option><option>No</option></select></div>
<div><label class="req">MP Required</label><input name="mpReq"></div>
<div><label class="req">Shifts</label><input name="shifts"></div>
<div><label class="req">QC Time</label><input name="qcTime"></div>
<div><label class="req">Working Days</label><input name="workingDays"></div>
<div class="full-width"><label class="req">HOD</label><input name="hod"></div>

<button class="submit-btn">Submit</button>
</form>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDywbG-rcyBHFB6OhuJesqasadBYDRlrJk",
  authDomain: "laser-html-apps.firebaseapp.com",
  projectId: "laser-html-apps"
};

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw9WRFYDM4WpX7hYSwFHcE3uQxjEJwpRpbQXD-xw9DuKQr7eg3GsozQ-DWpEqVcGmsTww/exec";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

window.machines = [];

window.googleLogin = () => signInWithPopup(auth, provider);

onAuthStateChanged(auth, user => {
  if(user){
    document.getElementById("loginSection").style.display="none";
    document.getElementById("formSection").style.display="block";
    document.getElementById("userInfoDisplay").innerText = "Operator: " + user.displayName;
    document.getElementById("userEmail").value = user.email;
    loadMachineData();
  }
});

function loadMachineData(){
  const s = document.createElement("script");
  s.src = SCRIPT_URL + "?action=getMachines&callback=handleMachineData";
  document.body.appendChild(s);
}

window.handleMachineData = data => {
  window.machines = data;
};

const machineInput = document.getElementById("machineInput");
const machineList = document.getElementById("machineList");
const costCode = document.getElementById("costCode");

machineInput.addEventListener("input", () => {
  machineList.innerHTML="";
  const f = window.machines.filter(m => m.machine.toLowerCase().includes(machineInput.value.toLowerCase()));
  f.forEach(m=>{
    const d=document.createElement("div");
    d.innerText=m.machine;
    d.onclick=()=>{machineInput.value=m.machine;costCode.value=m.costCode;machineList.style.display="none";}
    machineList.appendChild(d);
  });
  machineList.style.display="block";
});

document.getElementById("entryForm").onsubmit = e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());
  fetch(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)})
    .then(r=>r.json())
    .then(()=>Swal.fire("Success","Data Saved","success"));
};

</script>
</body>
</html>
